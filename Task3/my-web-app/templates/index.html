<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¸ ë ˆíŠ¸ë¡œ ì±„íŒ… í„°ë¯¸ë„ ğŸŒ¸</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¸</text></svg>">
</head>
<body>
  <div class="scanlines"></div>
  <div class="container">
    <div class="header">
      <div class="header-border"></div>
      <h1 class="glitch" data-text="â˜… ë ˆíŠ¸ë¡œ ì±„íŒ… â˜…">â˜… ë ˆíŠ¸ë¡œ ì±„íŒ… â˜…</h1>
      <div class="subtitle">ğŸŒ¸ ë¹ˆí‹°ì§€ ì• ë‹ˆë©” í„°ë¯¸ë„ v1.0 ğŸŒ¸</div>
      <div class="header-border"></div>
    </div>
    
    <div class="screen">
      <div class="screen-inner">
        <div class="response-label">ï¼ï¼ ì±„íŒ… íˆìŠ¤í† ë¦¬ ï¼œï¼œ</div>
        <div id="chatHistory" class="chat-history">
          <div class="system-message">
            <span class="cursor-blink">â–¸</span> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ... ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!
          </div>
        </div>
      </div>
    </div>
    
    <div class="controls">
      <div class="input-container">
        <div class="input-label">ë©”ì‹œì§€ ì…ë ¥:</div>
        <input type="text" id="userInput" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      </div>
      
      <div class="button-container">
        <button id="micBtn" class="retro-btn mic-btn">
          <span class="btn-inner">ğŸ¤ ìŒì„±</span>
        </button>
        <button id="sendBtn" class="retro-btn send-btn">
          <span class="btn-inner">ì „ì†¡ â–¶</span>
        </button>
      </div>
    </div>
    
    <div class="footer">
      <div class="status-bar">
        <span class="status-item">STATUS: <span class="status-ok">ONLINE</span></span>
        <span class="status-item">MODE: <span class="status-mode">VINTAGE</span></span>
        <span class="status-item">SYSTEM: <span class="status-ready">READY</span></span>
      </div>
    </div>
  </div>

  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  <script>
    let recognizer = null;
    let synthesizer = null;

    // í˜„ì¬ ì‹œê°„ í¬ë§·
    function _getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    // ì±„íŒ… íˆìŠ¤í† ë¦¬ì— ë©”ì‹œì§€ ì¶”ê°€
    function _addMessageToHistory(message, isUser = false) {
      const chatHistory = document.getElementById('chatHistory');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user-msg' : 'bot-msg'}`;
      
      const timeStr = _getCurrentTime();
      messageDiv.innerHTML = `
        <div class="message-content">
          ${_escapeHtml(message)}
          <div class="message-time">${timeStr}</div>
        </div>
      `;
      
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function _escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function _initSpeechConfig() {
      const tokenResponse = await fetch('/speech-token');
      const { key, region } = await tokenResponse.json();
      return { key, region };
    }

    async function _speakText(text) {
      try {
        const { key, region } = await _initSpeechConfig();
        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(key, region);
        speechConfig.speechSynthesisVoiceName = 'ko-KR-SunHiNeural';
        
        const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
        synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);
        
        synthesizer.speakTextAsync(
          text,
          result => {
            if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
              console.log('ğŸ”Š ìŒì„± ì¶œë ¥ ì™„ë£Œ');
            }
            synthesizer.close();
            synthesizer = null;
          },
          error => {
            console.error('âŒ ìŒì„± í•©ì„± ì˜¤ë¥˜:', error);
            synthesizer.close();
            synthesizer = null;
          }
        );
      } catch (error) {
        console.error('âŒ TTS ì˜¤ë¥˜:', error);
      }
    }

    // Enter í‚¤ ì´ë²¤íŠ¸
    document.getElementById('userInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('sendBtn').click();
      }
    });

    document.getElementById('sendBtn').addEventListener('click', async () => {
      const input = document.getElementById('userInput').value;
      const chatHistory = document.getElementById('chatHistory');
      
      if (!input.trim()) {
        const warningMsg = document.createElement('div');
        warningMsg.className = 'system-message';
        warningMsg.textContent = 'âš ï¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”ï¼';
        chatHistory.appendChild(warningMsg);
        setTimeout(() => warningMsg.remove(), 3000);
        _playRetroSound('error');
        return;
      }
      
      // ë ˆíŠ¸ë¡œ ì‚¬ìš´ë“œ ì¬ìƒ
      _playRetroSound('send');
      
      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      _addMessageToHistory(input, true);
      
      // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'chat-message bot-msg loading-msg';
      loadingMsg.innerHTML = `
        <div class="message-content">
          <span class="cursor-blink">â–¸</span> ì‹œìŠ¤í…œ ì²˜ë¦¬ì¤‘...
        </div>
      `;
      chatHistory.appendChild(loadingMsg);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      
      let dots = 0;
      const loadingInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        loadingMsg.querySelector('.message-content').innerHTML = 
          '<span class="cursor-blink">â–¸</span> ì‹œìŠ¤í…œ ì²˜ë¦¬ì¤‘' + '.'.repeat(dots);
      }, 300);
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('userInput').value = '';
      
      try {
        const response = await fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: input })
        });
        
        clearInterval(loadingInterval);
        loadingMsg.remove();
        
        const data = await response.json();
        
        // ë´‡ ì‘ë‹µ ì¶”ê°€
        _addMessageToHistory(data.response, false);
        
        // ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ìŒì„±ìœ¼ë¡œ ì¶œë ¥
        await _speakText(data.response);
        
      } catch (error) {
        clearInterval(loadingInterval);
        loadingMsg.remove();
        _addMessageToHistory('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, false);
        _playRetroSound('error');
      }
    });

    document.getElementById('micBtn').addEventListener('click', async () => {
      const micBtn = document.getElementById('micBtn');
      const userInput = document.getElementById('userInput');

      if (recognizer) {
        recognizer.stopContinuousRecognitionAsync();
        recognizer = null;
        micBtn.classList.remove('recording');
        micBtn.innerHTML = '<span class="btn-inner">ğŸ¤ ìŒì„±</span>';
        return;
      }

      try {
        const { key, region } = await _initSpeechConfig();
        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(key, region);
        speechConfig.speechRecognitionLanguage = 'ko-KR';
        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        
        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
        
        micBtn.classList.add('recording');
        micBtn.innerHTML = '<span class="btn-inner">â¹ï¸ åœæ­¢</span>';
        _playRetroSound('send');

        recognizer.recognizing = (s, e) => {
          console.log('ğŸ¤ ì¸ì‹ ì¤‘:', e.result.text);
        };

        recognizer.recognized = (s, e) => {
          console.log('âœ… ì¸ì‹ ì™„ë£Œ:', e.result);
          if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
            userInput.value = e.result.text;
            recognizer.stopContinuousRecognitionAsync(() => {
              recognizer.close();
              recognizer = null;
              micBtn.classList.remove('recording');
              micBtn.innerHTML = '<span class="btn-inner">ğŸ¤ ìŒì„±</span>';
            });
          }
        };

        recognizer.canceled = (s, e) => {
          console.log('âŒ ì·¨ì†Œë¨:', e);
          recognizer = null;
          micBtn.classList.remove('recording');
          micBtn.innerHTML = '<span class="btn-inner">ğŸ¤ ìŒì„±</span>';
        };

        recognizer.startContinuousRecognitionAsync();
      } catch (error) {
        console.error('âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', error);
        const responseDiv = document.getElementById('response');
        _typeWriter(responseDiv, 'âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + error.message);
        micBtn.classList.remove('recording');
        micBtn.innerHTML = '<span class="btn-inner">ğŸ¤ ìŒì„±</span>';
        _playRetroSound('error');
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œê±° (ì´ë¯¸ HTMLì— ìˆìŒ)
    window.addEventListener('load', () => {
      console.log('ğŸŒ¸ ë¹ˆí‹°ì§€ ì• ë‹ˆë©” í„°ë¯¸ë„ v1.0 ë¡œë”© ì™„ë£Œ');
    });
  </script>
</body>
</html>